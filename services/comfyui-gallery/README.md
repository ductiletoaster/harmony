# Smart ComfyUI Gallery Setup

A Docker-based setup for running [Smart ComfyUI Gallery](https://github.com/biagiomaf/comfyui-gallery), a fast, beautiful, and mobile-friendly gallery to organize and manage files generated with ComfyUI.

## About This Project

Smart ComfyUI Gallery provides a **production-ready, containerized solution** for managing your ComfyUI-generated images and videos. It automatically links generated files to their original workflows, making it easy to recall and reproduce your best results.

### Key Features
- **Workflow Recall** - Automatically links files to their original ComfyUI workflows
- **Universal Upload** - Drag-and-drop support for images and videos from any source
- **Node Summary** - Displays model, seed, and key parameters at a glance
- **Smart Organization** - Expandable sidebar with real-time search and bi-directional sorting
- **Advanced Lightbox** - Mouse wheel zoom with persistent zoom levels
- **Real-time Sync** - Background file detection with visual progress indicators
- **Standalone Operation** - Functions independently when ComfyUI is offline
- **Multi-format Support** - Handles PNG, JPG, MP4, and WebP files

## Requirements

1. Install [Docker](http://docker.io)
2. (optional) Install [Docker Compose](http://docs.docker.com/compose/install/)
3. Running ComfyUI instance (or access to ComfyUI output/input directories)
4. Clone this repository

**Note**: Traefik proxy network is required for HTTPS access in production.

## Quick Start

### 1. Setup Environment

Choose the appropriate environment file for your deployment:

**For local development:**
```bash
cp .env.local.example .env
```

**For TrueNAS Dockge deployment:**
```bash
cp .env.truenas.example .env
```

**For generic deployment:**
```bash
cp .env.example .env
```

Edit the `.env` file to configure:
- `HOSTNAME` - Your domain (e.g., `w01.pixeloven.com`)
- `COMFY_OUTPUT_PATH` - Path to your ComfyUI output directory
- `COMFY_INPUT_PATH` - Path to your ComfyUI input directory
- `GALLERY_DATA_PATH` - Where to store the gallery database and uploads

### 2. Build and Start the Service

```bash
# Build the Docker image
docker compose build

# Start the service
docker compose up -d
```

### 3. Access the Gallery

Open your browser and navigate to:
- **Local Access**: http://localhost:8189
- **Traefik Proxy**: https://gallery.{HOSTNAME} (e.g., https://gallery.w01.pixeloven.com)

## Configuration

### Environment Variables

- `PUID` / `PGID`: User/group IDs for file permissions (default: 1000)
- `TZ`: Timezone for the container (default: Etc/UTC)
- `HOSTNAME`: Domain suffix for Traefik routing
- `GALLERY_DATA_PATH`: Where SQLite database and uploads are stored
- `COMFY_OUTPUT_PATH`: Path to ComfyUI output directory (read-only)
- `COMFY_INPUT_PATH`: Path to ComfyUI input directory (read-only)
- `BASE_OUTPUT_PATH`: Internal container path for output (default: /comfyui/output)
- `BASE_INPUT_PATH`: Internal container path for input (default: /comfyui/input)
- `FFPROBE_MANUAL_PATH`: Optional custom FFprobe path for video metadata

### Volume Mapping

The service requires access to your ComfyUI directories:

**Local Development:**
```yaml
volumes:
  - ./data:/app/data                           # Gallery database
  - ../comfyui/data/output:/comfyui/output:ro  # ComfyUI outputs (read-only)
  - ../comfyui/data/input:/comfyui/input:ro    # ComfyUI inputs (read-only)
```

**TrueNAS Dockge:**
```yaml
volumes:
  - /mnt/Media/libraries/dockge/comfyui-gallery/data:/app/data
  - /home/brian/ComfyUI/output:/comfyui/output:ro
  - /home/brian/ComfyUI/input:/comfyui/input:ro
```

## Project Structure

```
services/comfyui-gallery/
├── docker-compose.yml         # Docker Compose configuration
├── Dockerfile                 # Container build instructions
├── .env.example              # Generic environment template
├── .env.local.example        # Local development template
├── .env.truenas.example      # TrueNAS Dockge template
├── README.md                 # This file
└── data/                     # Gallery database and uploads (created on first run)
```

## Usage

### Daily Operations

Start the service:
```bash
docker compose up -d
```

Stop the service:
```bash
docker compose down
```

View logs:
```bash
docker compose logs -f
```

Update to latest version:
```bash
docker compose build --no-cache
docker compose up -d
```

### File Organization

The gallery automatically scans your ComfyUI output directory and:
1. Indexes all PNG, JPG, MP4, and WebP files
2. Extracts workflow metadata from ComfyUI-generated files
3. Displays node parameters (model, seed, dimensions, etc.)
4. Enables workflow recall with a single click

You can also upload files directly to the gallery that weren't generated by ComfyUI.

## Integration with ComfyUI

This service is designed to work alongside your existing ComfyUI setup:

1. **Shared Storage**: Gallery mounts ComfyUI directories in read-only mode
2. **Real-time Sync**: Automatically detects new files generated by ComfyUI
3. **Workflow Recall**: Click any image to load its workflow back into ComfyUI
4. **Independent Operation**: Works even when ComfyUI is offline

### Connecting to Your ComfyUI Instance

Update your `.env` file to point to your ComfyUI directories:

```bash
# For local ComfyUI running in ../comfyui/
COMFY_OUTPUT_PATH=../comfyui/data/output
COMFY_INPUT_PATH=../comfyui/data/input

# For TrueNAS deployment
COMFY_OUTPUT_PATH=/home/brian/ComfyUI/output
COMFY_INPUT_PATH=/home/brian/ComfyUI/input
```

## Troubleshooting

### Common Issues

**Gallery can't find ComfyUI files:**
- Verify `COMFY_OUTPUT_PATH` points to the correct directory
- Check file permissions (PUID/PGID should match your user)
- Ensure the volume mount is correct in docker-compose.yml

**Port conflict on 8189:**
- Change the port mapping in docker-compose.yml if needed
- Update Traefik labels to match the new port

**Database or uploads not persisting:**
- Verify `GALLERY_DATA_PATH` is correctly set
- Check that the directory has proper write permissions

**Video metadata not extracting:**
- Ensure FFmpeg is installed (included in the Docker image)
- Check `FFPROBE_MANUAL_PATH` if using a custom FFmpeg installation

### Logs and Debugging

View application logs:
```bash
docker compose logs -f comfyui-gallery
```

Check container status:
```bash
docker compose ps
```

Access container shell:
```bash
docker compose exec comfyui-gallery bash
```

Verify volume mounts:
```bash
docker compose exec comfyui-gallery ls -la /comfyui/output
docker compose exec comfyui-gallery ls -la /comfyui/input
```

## References

- [Smart ComfyUI Gallery Repository](https://github.com/biagiomaf/comfyui-gallery)
- [ComfyUI Documentation](https://github.com/comfyanonymous/ComfyUI)
- [Docker Documentation](https://docs.docker.com/)
- [Traefik Documentation](https://doc.traefik.io/traefik/)
